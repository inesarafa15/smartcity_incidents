<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails Incident - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <th:block th:replace="~{fragments/sidebar :: sidebar-styles}"></th:block>
</head>
<body>
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>
    <div class="main-content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Détails Incident</h2>
                <a th:href="@{/admin/incidents}" class="btn btn-secondary">Retour</a>
            </div>

            <!-- Alerts replaced by SweetAlert2 (handled in script) -->

            <div th:if="${incident}" class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0" th:text="${incident.titre}"></h4>
                        <small class="text-muted">Statut: <span th:text="${incident.statut}"></span></small>
                    </div>
                    <div>
                        <span class="badge bg-primary" th:text="${incident.priorite}"></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4" th:if="${incident.statut != null && incident.statut.name() == 'RESOLU'}">
                        <div class="card shadow-sm border-start border-5 border-info bg-light">
                            <div class="card-body">
                                <h5 class="card-title text-info mb-3">
                                    ℹ️ Validation de la résolution requise
                                </h5>
                                <p class="card-text text-muted mb-3">
                                    L'agent a marqué cet incident comme résolu. Veuillez examiner les preuves et le feedback ci-dessous avant de valider ou refuser.
                                </p>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="p-3 bg-white rounded shadow-sm border border-success-subtle h-100">
                                            <div class="d-flex align-items-center mb-2 text-success">
                                                <span class="fs-4 me-2">✅</span>
                                                <strong>Action : Valider</strong>
                                            </div>
                                            <small class="text-muted d-block">
                                                L'incident passera au statut <strong>CLOTURÉ</strong>. Le dossier sera archivé.
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 bg-white rounded shadow-sm border border-danger-subtle h-100">
                                            <div class="d-flex align-items-center mb-2 text-danger">
                                                <span class="fs-4 me-2">❌</span>
                                                <strong>Action : Refuser</strong>
                                            </div>
                                            <small class="text-muted d-block">
                                                L'incident retournera à <strong>PRIS_EN_CHARGE</strong>. L'agent sera notifié par email pour reprendre le travail.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Agent assigné</strong>
                            <div>
                                <span th:if="${incident.agentAssigne != null}" th:text="${incident.agentAssigne.prenom + ' ' + incident.agentAssigne.nom}"></span>
                                <span th:unless="${incident.agentAssigne != null}" class="text-muted">Non assigné</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <strong>Localisation</strong>
                            <div>
                                <a th:if="${incident.latitude != null && incident.longitude != null}"
                                   th:href="@{https://www.google.com/maps?q={coord}(coord=${incident.latitude + ',' + incident.longitude})}"
                                   target="_blank" class="btn btn-sm btn-outline-secondary">Voir sur la carte</a>
                                <span th:unless="${incident.latitude != null && incident.longitude != null}" class="text-muted">Non renseignée</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Description</strong>
                        <p th:text="${incident.description}"></p>
                    </div>
                    
                    <div th:if="${incident.photos != null && !incident.photos.isEmpty()}" class="mb-3">
                        <!-- Photos de création -->
                        <div th:with="creationPhotos=${incident.photos.?[typePhoto == null || typePhoto.name() == 'CREATION']}">
                            <div th:if="${!creationPhotos.isEmpty()}">
                                <strong>Photos du signalement (Citoyen)</strong>
                                <div class="row mt-2">
                                    <div th:each="photo : ${creationPhotos}" class="col-md-3 mb-2">
                                        <img th:src="@{'/' + ${photo.cheminFichier}}" class="img-thumbnail" alt="Photo">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Photos de résolution -->
                        <div th:with="resolutionPhotos=${incident.photos.?[typePhoto != null && typePhoto.name() == 'RESOLUTION']}" class="mt-3">
                            <div th:if="${!resolutionPhotos.isEmpty()}">
                                <strong>Preuves de résolution (Agent)</strong>
                                <div class="row mt-2">
                                    <div th:each="photo : ${resolutionPhotos}" class="col-md-3 mb-2">
                                        <img th:src="@{'/' + ${photo.cheminFichier}}" class="img-thumbnail" alt="Photo">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Commentaire de l'agent</strong>
                        <p th:if="${incident.notificationsIncident != null}"
                           th:text="${#lists.isEmpty(incident.notificationsIncident) ? 'Aucun' : incident.notificationsIncident.get(incident.notificationsIncident.size() - 1).message}"></p>
                    </div>

                    <div class="mb-3">
                        <strong>Feedback du citoyen</strong>
                        <div class="row">
                            <div class="col-md-4">
                                <div>Évaluation: <span th:text="${incident.feedbackSatisfait == null ? 'N/A' : (incident.feedbackSatisfait ? 'Satisfait' : 'Non satisfait')}"></span></div>
                            </div>
                            <div class="col-md-4">
                                <div>Note: <span th:text="${incident.feedbackNote == null ? 'N/A' : incident.feedbackNote}"></span></div>
                            </div>
                            <div class="col-md-4">
                                <div>Date: <span th:if="${incident.dateFeedback != null}" th:text="${#temporals.format(incident.dateFeedback, 'dd/MM/yyyy HH:mm')}"></span></div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div th:text="${incident.feedbackCommentaire != null ? incident.feedbackCommentaire : 'Aucun commentaire'}"></div>
                        </div>
                    </div>

                    <div class="d-flex gap-2" th:if="${incident.statut != null && incident.statut.name() == 'RESOLU'}">
                        <form th:action="@{/admin/incidents/{id}/valider(id=${incident.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-success">Valider la résolution</button>
                        </form>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#refusModal">Refuser la résolution</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="refusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/admin/incidents/{id}/refuser(id=${incident.id})}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Refuser la résolution</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Motif (optionnel)</label>
                            <textarea class="form-control" name="motif" rows="4" placeholder="Expliquez brièvement la raison du refus"></textarea>
                        </div>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-danger">Confirmer le refus</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            var successMsg = /*[[${success}]]*/ null;
            var errorMsg = /*[[${error}]]*/ null;

            if (successMsg && successMsg !== 'null' && successMsg !== '') {
                Swal.fire({
                    icon: 'success',
                    title: 'Succès',
                    text: successMsg,
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }

            if (errorMsg && errorMsg !== 'null' && errorMsg !== '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: errorMsg,
                    position: 'top-end',
                    toast: true,
                    timer: 5000,
                    showConfirmButton: false
                });
            }
        });
        /*]]>*/
    </script>
</body>
</html>
