<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Agent Municipal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <th:block th:replace="~{fragments/sidebar :: sidebar-styles}"></th:block>
    <style>
        .page-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .card-stats {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s;
            overflow: hidden;
        }
        .card-stats:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        .card-chart {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            background: #fff;
        }
        .card-chart .card-header {
            background: transparent;
            border-bottom: 2px solid #f0f0f0;
            padding: 20px 25px;
            font-weight: 600;
            color: #2c3e50;
        }
        .card-chart .card-body {
            padding: 25px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0 5px 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0;
        }
        .incident-table {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .incident-table .table-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .badge-custom {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>
    
    <div class="main-content">
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-2">
                            <i class="fas fa-tachometer-alt"></i> Tableau de Bord Agent
                        </h1>
                        <p class="mb-0 opacity-75">Vue d'ensemble de mes assignations</p>
                    </div>
                    <div>
                        <a th:href="@{/agent/mes-assignations}" class="btn btn-light btn-lg">
                            <i class="fas fa-clipboard-list"></i> Tous mes incidents
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats Cards Row -->
            <div class="row mb-4 g-3">
                <!-- Total assignés -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-stats h-100">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon" style="background: rgba(23, 162, 184, 0.1); color: #17a2b8;">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="stat-label">Mes Incidents</h6>
                                    <h3 class="stat-number" th:text="${incidentsAssignes != null ? incidentsAssignes.size() : 0}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- En cours -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-stats h-100">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon" style="background: rgba(255, 193, 7, 0.1); color: #ffc107;">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="stat-label">En Cours</h6>
                                    <h3 class="stat-number" th:text="${(incidentsParStatut['PRIS_EN_CHARGE'] ?: 0) + (incidentsParStatut['EN_RESOLUTION'] ?: 0)}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Résolus -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-stats h-100">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="stat-label">Résolus</h6>
                                    <h3 class="stat-number" th:text="${incidentsParStatut['RESOLU'] ?: 0}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critiques -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-stats h-100">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 stat-icon" style="background: rgba(220, 53, 69, 0.1); color: #dc3545;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="stat-label">Critiques</h6>
                                    <h3 class="stat-number" th:text="${incidentsParPriorite['CRITIQUE'] ?: 0}">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <!-- Graphique par statut -->
                <div class="col-md-6 mb-4">
                    <div class="card card-chart h-100">
                        <div class="card-header">
                            <i class="fas fa-chart-pie text-info me-2"></i>Répartition par Statut
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique par priorité -->
                <div class="col-md-6 mb-4">
                    <div class="card card-chart h-100">
                        <div class="card-header">
                            <i class="fas fa-chart-bar text-danger me-2"></i>Répartition par Priorité
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="prioriteChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des incidents récents -->
            <div class="incident-table">
                <div class="table-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Mes Incidents Récents
                    </h5>
                    <a th:href="@{/agent/mes-assignations}" class="btn btn-light btn-sm">
                        Voir tous <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                
                <!-- État vide -->
                <div th:if="${incidentsAssignes == null or incidentsAssignes.isEmpty()}" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h4>Aucun incident assigné</h4>
                    <p class="text-muted">Les incidents qui vous seront assignés apparaîtront ici</p>
                </div>

                <!-- Tableau avec données -->
                <div th:unless="${incidentsAssignes == null or incidentsAssignes.isEmpty()}" class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead style="background: #f8f9fa;">
                            <tr>
                                <th class="px-4 py-3">Incident</th>
                                <th class="py-3">Statut</th>
                                <th class="py-3">Priorité</th>
                                <th class="py-3">Date</th>
                                <th class="py-3 text-end px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="incident, iterStat : ${incidentsAssignes}" th:if="${iterStat.index < 5}">
                                <td class="px-4">
                                    <strong th:text="${incident.titre}">Titre</strong><br/>
                                    <small class="text-muted" th:text="${incident.description != null ? (#strings.length(incident.description) > 60 ? #strings.substring(incident.description, 0, 60) + '...' : incident.description) : '-'}">Description</small>
                                </td>
                                <td>
                                    <th:block th:switch="${incident.statut?.name()}">
                                        <span th:case="'SIGNALE'" class="badge-custom bg-secondary text-white">
                                            <i class="fas fa-flag"></i> SIGNALÉ
                                        </span>
                                        <span th:case="'PRIS_EN_CHARGE'" class="badge-custom bg-info text-white">
                                            <i class="fas fa-hand-paper"></i> PRIS EN CHARGE
                                        </span>
                                        <span th:case="'EN_RESOLUTION'" class="badge-custom bg-warning text-dark">
                                            <i class="fas fa-tools"></i> EN RÉSOLUTION
                                        </span>
                                        <span th:case="'RESOLU'" class="badge-custom bg-success text-white">
                                            <i class="fas fa-check-circle"></i> RÉSOLU
                                        </span>
                                        <span th:case="'CLOTURE'" class="badge-custom bg-dark text-white">
                                            <i class="fas fa-archive"></i> CLÔTURÉ
                                        </span>
                                        <span th:case="*" class="text-muted">N/A</span>
                                    </th:block>
                                </td>
                                <td>
                                    <th:block th:switch="${incident.priorite?.name()}">
                                        <span th:case="'FAIBLE'" class="badge-custom bg-secondary text-white">
                                            <i class="fas fa-minus-circle"></i> FAIBLE
                                        </span>
                                        <span th:case="'MOYENNE'" class="badge-custom bg-primary text-white">
                                            <i class="fas fa-info-circle"></i> MOYENNE
                                        </span>
                                        <span th:case="'ELEVEE'" class="badge-custom bg-warning text-dark">
                                            <i class="fas fa-exclamation-circle"></i> ÉLEVÉE
                                        </span>
                                        <span th:case="'CRITIQUE'" class="badge-custom bg-danger text-white">
                                            <i class="fas fa-exclamation-triangle"></i> CRITIQUE
                                        </span>
                                        <span th:case="*" class="text-muted">N/A</span>
                                    </th:block>
                                </td>
                                <td>
                                    <i class="fas fa-calendar-alt text-muted"></i>
                                    <span th:text="${incident.dateCreation != null ? #temporals.format(incident.dateCreation, 'dd/MM/yyyy HH:mm') : 'N/A'}">Date</span>
                                </td>
                                <td class="text-end px-4">
                                    <a th:href="@{/agent/incidents/{id}(id=${incident.id})}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i> Voir
                                    </a>
                                    <a th:if="${incident.latitude != null and incident.longitude != null}"
                                       th:href="@{'https://www.google.com/maps?q=' + ${incident.latitude} + ',' + ${incident.longitude}}"
                                       target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            // SweetAlert2 notifications
            const successMsg = /*[[${success}]]*/ null;
            const errorMsg = /*[[${error}]]*/ null;

            if (successMsg && successMsg !== 'null' && successMsg !== '') {
                Swal.fire({
                    icon: 'success',
                    title: 'Succès',
                    text: successMsg,
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }

            if (errorMsg && errorMsg !== 'null' && errorMsg !== '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: errorMsg,
                    position: 'top-end',
                    toast: true,
                    timer: 5000,
                    showConfirmButton: false
                });
            }

            // Données pour les graphiques
            const statutData = /*[[${incidentsParStatut}]]*/ {};
            const prioriteData = /*[[${incidentsParPriorite}]]*/ {};

            // Graphique par statut
            const statutCtx = document.getElementById('statutChart');
            if (statutCtx && statutData && Object.keys(statutData).length > 0) {
                new Chart(statutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statutData),
                        datasets: [{
                            data: Object.values(statutData),
                            backgroundColor: ['#6c757d', '#17a2b8', '#ffc107', '#28a745', '#343a40'],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12, weight: 500 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = context.parsed || 0;
                                        let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        let percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': ' + value + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Graphique par priorité
            const prioriteCtx = document.getElementById('prioriteChart');
            if (prioriteCtx && prioriteData && Object.keys(prioriteData).length > 0) {
                new Chart(prioriteCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(prioriteData),
                        datasets: [{
                            label: 'Nombre d\'incidents',
                            data: Object.values(prioriteData),
                            backgroundColor: ['#6c757d', '#007bff', '#ffc107', '#dc3545'],
                            borderRadius: 8,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: { size: 11 }
                                },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            x: {
                                ticks: {
                                    font: { size: 11, weight: 500 }
                                },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        });
        /*]]>*/
    </script>
</body>
</html>