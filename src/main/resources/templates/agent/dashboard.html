<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Agent Municipal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <th:block th:replace="~{fragments/sidebar :: sidebar-styles}"></th:block>
    <style>
        .page-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stats-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .chart-card, .table-card {
            background: #fff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }
        .chart-container {
            position: relative;
            height: 300px;
            padding: 20px;
        }
        .table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #2c3e50;
            padding: 15px;
            background: #f8f9fa;
        }
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
        }
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        .badge-status {
            font-size: 0.85rem;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
        }
        .table-actions .btn {
            margin: 0 2px;
            border-radius: 6px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .card-header {
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 20px 25px;
        }
        .card-header h5 {
            font-weight: 600;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>
    
    <div class="main-content">
        <div class="container-fluid p-4">
            <!-- En-tête -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-2">
                            <i class="fas fa-tachometer-alt"></i> Tableau de bord
                        </h1>
                        <p class="mb-0 opacity-75">Vue d'ensemble de vos assignations et statistiques</p>
                    </div>
                    <div>
                        <a th:href="@{/agent/mes-assignations}" class="btn btn-light">
                            <i class="fas fa-clipboard-list"></i> Voir mes incidents
                        </a>
                    </div>
                </div>
            </div>

            <!-- Cartes de statistiques -->
            <div class="row mb-4">
                <!-- Total des incidents assignés -->
                <div class="col-md-4 mb-3">
                    <div class="card stats-card bg-primary text-white h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-clipboard-list fa-3x opacity-75"></i>
                            </div>
                            <h3 class="display-4 fw-bold" th:text="${incidentsAssignes != null ? incidentsAssignes.size() : 0}">0</h3>
                            <p class="mb-0 text-uppercase fw-bold opacity-75">Mes incidents assignés</p>
                        </div>
                    </div>
                </div>

                <!-- Incidents en cours -->
                <div class="col-md-4 mb-3">
                    <div class="card stats-card bg-warning text-dark h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-hourglass-half fa-3x opacity-75"></i>
                            </div>
                            <h3 class="display-4 fw-bold" th:text="${(incidentsParStatut['PRIS_EN_CHARGE'] ?: 0) + (incidentsParStatut['EN_RESOLUTION'] ?: 0)}">0</h3>
                            <p class="mb-0 text-uppercase fw-bold opacity-75">En cours</p>
                        </div>
                    </div>
                </div>

                <!-- Incidents résolus -->
                <div class="col-md-4 mb-3">
                    <div class="card stats-card bg-success text-white h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                                <i class="fas fa-check-circle fa-3x opacity-75"></i>
                            </div>
                            <h3 class="display-4 fw-bold" th:text="${incidentsParStatut['RESOLU'] ?: 0}">0</h3>
                            <p class="mb-0 text-uppercase fw-bold opacity-75">Résolus</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="row mb-4">
                <!-- Graphique par statut -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie text-primary me-2"></i> Incidents par statut
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique par priorité -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar text-warning me-2"></i> Incidents par priorité
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="prioriteChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des incidents récents -->
            <div class="row">
                <div class="col-12">
                    <div class="card table-card">
                        <div class="card-header d-flex justify-content-between align-items-center bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i> Mes incidents assignés récents
                            </h5>
                            <a th:href="@{/agent/mes-assignations}" class="btn btn-sm btn-outline-primary">
                                Voir tous <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <!-- État vide -->
                            <div th:if="${incidentsAssignes == null or incidentsAssignes.isEmpty()}" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h4>Aucun incident assigné pour le moment.</h4>
                                <p class="text-muted">Les incidents qui vous seront assignés apparaîtront ici.</p>
                            </div>

                            <!-- Tableau avec données -->
                            <div th:unless="${incidentsAssignes == null or incidentsAssignes.isEmpty()}" class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Titre</th>
                                            <th>Statut</th>
                                            <th>Priorité</th>
                                            <th>Date création</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="incident, iterStat : ${incidentsAssignes}" th:if="${iterStat.index < 5}">
                                            <td>
                                                <strong th:text="${incident.titre ?: 'Sans titre'}" class="text-dark">Titre</strong><br/>
                                                <small class="text-muted" th:text="${incident.description != null and !#strings.isEmpty(incident.description) ? (incident.description.length() > 60 ? incident.description.substring(0, 60) + '...' : incident.description) : '-'}">Description</small>
                                            </td>
                                            <td>
                                                <th:block th:switch="${incident.statut?.name()}">
                                                    <span th:case="'SIGNALE'" class="badge badge-status bg-secondary" th:text="${incident.statut.name()}">SIGNALE</span>
                                                    <span th:case="'PRIS_EN_CHARGE'" class="badge badge-status bg-info" th:text="${incident.statut.name()}">PRIS_EN_CHARGE</span>
                                                    <span th:case="'EN_RESOLUTION'" class="badge badge-status bg-warning text-dark" th:text="${incident.statut.name()}">EN_RESOLUTION</span>
                                                    <span th:case="'RESOLU'" class="badge badge-status bg-success" th:text="${incident.statut.name()}">RESOLU</span>
                                                    <span th:case="*" class="text-muted">-</span>
                                                </th:block>
                                            </td>
                                            <td>
                                                <th:block th:switch="${incident.priorite?.name()}">
                                                    <span th:case="'BASSE'" class="badge badge-status bg-secondary" th:text="${incident.priorite.name()}">BASSE</span>
                                                    <span th:case="'MOYENNE'" class="badge badge-status bg-primary" th:text="${incident.priorite.name()}">MOYENNE</span>
                                                    <span th:case="'HAUTE'" class="badge badge-status bg-warning text-dark" th:text="${incident.priorite.name()}">HAUTE</span>
                                                    <span th:case="'URGENTE'" class="badge badge-status bg-danger" th:text="${incident.priorite.name()}">URGENTE</span>
                                                    <span th:case="*" class="text-muted">-</span>
                                                </th:block>
                                            </td>
                                            <td>
                                                <i class="fas fa-calendar-alt text-muted me-1"></i>
                                                <span th:if="${incident.dateCreation != null}" th:text="${#temporals.format(incident.dateCreation, 'dd/MM/yyyy HH:mm')}">Date</span>
                                                <span th:unless="${incident.dateCreation != null}" class="text-muted">-</span>
                                            </td>
                                            <td class="text-end table-actions">
                                                <!-- Bouton selon le statut -->
                                                <form th:if="${incident.statut != null and incident.statut.name() == 'PRIS_EN_CHARGE'}"
                                                      th:action="@{/agent/incidents/{id}/en-resolution(id=${incident.id})}" 
                                                      method="post"
                                                      style="display: inline;"
                                                      onsubmit="return confirm('Voulez-vous mettre cet incident en résolution ?');">
                                                    <button type="submit" class="btn btn-sm btn-warning">
                                                        <i class="fas fa-tools"></i>
                                                    </button>
                                                </form>
                                                
                                                <form th:if="${incident.statut != null and incident.statut.name() == 'EN_RESOLUTION'}"
                                                      th:action="@{/agent/incidents/{id}/resolu(id=${incident.id})}" 
                                                      method="post"
                                                      style="display: inline;"
                                                      onsubmit="return confirm('Confirmez-vous que cet incident est résolu ?');">
                                                    <button type="submit" class="btn btn-sm btn-success">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                                
                                                <a th:href="@{/agent/incidents/{id}(id=${incident.id})}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a th:if="${incident.latitude != null && incident.longitude != null}"
                                                   th:href="@{https://www.google.com/maps?q={coord}(coord=${incident.latitude + ',' + incident.longitude})}"
                                                   class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-map-location-dot"></i>
                                                </a>
                                                <a th:unless="${incident.latitude != null && incident.longitude != null}"
                                                   th:href="@{https://www.google.com/maps?q={addr}(addr=${incident.adresseTextuelle})}"
                                                   class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-map-location-dot"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion des notifications SweetAlert2
            const successMsg = /*[[${success}]]*/ null;
            const errorMsg = /*[[${error}]]*/ null;

            if (successMsg) {
                Swal.fire({
                    icon: 'success',
                    title: 'Succès',
                    text: successMsg,
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }

            if (errorMsg) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: errorMsg,
                    position: 'top-end',
                    toast: true,
                    timer: 5000,
                    showConfirmButton: false
                });
            }

            const statutData = /*[[${incidentsParStatut}]]*/ {};
            const prioriteData = /*[[${incidentsParPriorite}]]*/ {};

            const statutColors = {
                'SIGNALE': '#6c757d',
                'PRIS_EN_CHARGE': '#17a2b8',
                'EN_RESOLUTION': '#ffc107',
                'RESOLU': '#28a745',
                'CLOTURE': '#dc3545'
            };

            const prioriteColors = {
                'BASSE': '#6c757d',
                'MOYENNE': '#007bff',
                'HAUTE': '#ffc107',
                'URGENTE': '#dc3545'
            };

            const statutCtx = document.getElementById('statutChart');
            if (statutCtx && statutData && Object.keys(statutData).length > 0) {
                const labels = Object.keys(statutData);
                const values = Object.values(statutData);
                const colors = labels.map(label => statutColors[label] || '#6c757d');

                new Chart(statutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15, font: { size: 12 } }
                            }
                        }
                    }
                });
            } else if (statutCtx) {
                const parent = statutCtx.parentElement;
                parent.innerHTML = '<div class="empty-state"><i class="fas fa-chart-pie"></i><p>Aucune donnée disponible</p></div>';
            }

            const prioriteCtx = document.getElementById('prioriteChart');
            if (prioriteCtx && prioriteData && Object.keys(prioriteData).length > 0) {
                const labels = Object.keys(prioriteData);
                const values = Object.values(prioriteData);
                const colors = labels.map(label => prioriteColors[label] || '#007bff');

                new Chart(prioriteCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nombre d\'incidents',
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 0,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, precision: 0 }
                            }
                        }
                    }
                });
            } else if (prioriteCtx) {
                const parent = prioriteCtx.parentElement;
                parent.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>Aucune donnée disponible</p></div>';
            }
        });
        /*]]>*/
    </script>
</body>
</html>