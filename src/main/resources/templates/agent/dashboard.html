<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Agent Municipal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <th:block th:replace="~{fragments/sidebar :: sidebar-styles}"></th:block>
    <style>
        .stats-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .chart-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }
        .chart-container {
            position: relative;
            height: 300px;
            padding: 20px;
        }
        .badge-status {
            font-size: 0.85rem;
            padding: 5px 12px;
            border-radius: 5px;
        }
        .table-actions .btn {
            margin: 0 2px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>
    
    <div class="main-content">
        <div class="container-fluid p-4">
            <!-- En-tête -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-tachometer-alt"></i> Tableau de bord Agent Municipal</h2>
                <a th:href="@{/agent/mes-assignations}" class="btn btn-primary">
                    <i class="fas fa-clipboard-list"></i> Voir tous mes incidents
                </a>
            </div>

            <!-- Messages Flash -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Cartes de statistiques -->
            <div class="row mb-4">
                <!-- Total des incidents assignés -->
                <div class="col-md-4 mb-3">
                    <div class="card stats-card bg-primary text-white">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-clipboard-list fa-3x opacity-75"></i>
                            </div>
                            <h3 class="display-4 fw-bold" th:text="${incidentsAssignes != null ? incidentsAssignes.size() : 0}">0</h3>
                            <p class="mb-0 text-uppercase">Mes incidents assignés</p>
                        </div>
                    </div>
                </div>

                <!-- Incidents en cours -->
                <div class="col-md-4 mb-3">
                    <div class="card stats-card bg-warning text-dark">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-hourglass-half fa-3x opacity-75"></i>
                            </div>
                            <h3 class="display-4 fw-bold" th:text="${(incidentsParStatut['PRIS_EN_CHARGE'] ?: 0) + (incidentsParStatut['EN_RESOLUTION'] ?: 0)}">0</h3>
                            <p class="mb-0 text-uppercase">En cours</p>
                        </div>
                    </div>
                </div>

                <!-- Incidents résolus -->
                <div class="col-md-4 mb-3">
                    <div class="card stats-card bg-success text-white">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-check-circle fa-3x opacity-75"></i>
                            </div>
                            <h3 class="display-4 fw-bold" th:text="${incidentsParStatut['RESOLU'] ?: 0}">0</h3>
                            <p class="mb-0 text-uppercase">Résolus</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="row mb-4">
                <!-- Graphique par statut -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie text-primary"></i> Incidents par statut
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique par priorité -->
                <div class="col-lg-6 mb-4">
                    <div class="card chart-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar text-warning"></i> Incidents par priorité
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="prioriteChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des incidents récents -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list"></i> Mes incidents assignés récents
                            </h5>
                            <a th:href="@{/agent/mes-assignations}" class="btn btn-sm btn-outline-primary">
                                Voir tous <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                        <div class="card-body">
                            <!-- État vide -->
                            <div th:if="${incidentsAssignes == null or incidentsAssignes.isEmpty()}" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h4>Aucun incident assigné pour le moment.</h4>
                                <p class="text-muted">Les incidents qui vous seront assignés apparaîtront ici.</p>
                            </div>

                            <!-- Tableau avec données -->
                            <div th:unless="${incidentsAssignes == null or incidentsAssignes.isEmpty()}" class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Titre</th>
                                            <th>Statut</th>
                                            <th>Priorité</th>
                                            <th>Date création</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="incident, iterStat : ${incidentsAssignes}" th:if="${iterStat.index < 5}">
                                            <td>
                                                <strong th:text="${incident.titre ?: 'Sans titre'}">Titre</strong><br/>
                                                <small class="text-muted" th:text="${incident.description != null and !#strings.isEmpty(incident.description) ? (incident.description.length() > 60 ? incident.description.substring(0, 60) + '...' : incident.description) : '-'}">Description</small>
                                            </td>
                                            <td>
                                                <th:block th:switch="${incident.statut?.name()}">
                                                    <span th:case="'SIGNALE'" class="badge badge-status bg-secondary" th:text="${incident.statut.name()}">SIGNALE</span>
                                                    <span th:case="'PRIS_EN_CHARGE'" class="badge badge-status bg-info" th:text="${incident.statut.name()}">PRIS_EN_CHARGE</span>
                                                    <span th:case="'EN_RESOLUTION'" class="badge badge-status bg-warning text-dark" th:text="${incident.statut.name()}">EN_RESOLUTION</span>
                                                    <span th:case="'RESOLU'" class="badge badge-status bg-success" th:text="${incident.statut.name()}">RESOLU</span>
                                                    <span th:case="*" class="text-muted">-</span>
                                                </th:block>
                                            </td>
                                            <td>
                                                <th:block th:switch="${incident.priorite?.name()}">
                                                    <span th:case="'BASSE'" class="badge badge-status bg-secondary" th:text="${incident.priorite.name()}">BASSE</span>
                                                    <span th:case="'MOYENNE'" class="badge badge-status bg-primary" th:text="${incident.priorite.name()}">MOYENNE</span>
                                                    <span th:case="'HAUTE'" class="badge badge-status bg-warning text-dark" th:text="${incident.priorite.name()}">HAUTE</span>
                                                    <span th:case="'URGENTE'" class="badge badge-status bg-danger" th:text="${incident.priorite.name()}">URGENTE</span>
                                                    <span th:case="*" class="text-muted">-</span>
                                                </th:block>
                                            </td>
                                            <td>
                                                <i class="fas fa-calendar-alt text-muted"></i>
                                                <span th:if="${incident.dateCreation != null}" th:text="${#temporals.format(incident.dateCreation, 'dd/MM/yyyy HH:mm')}">Date</span>
                                                <span th:unless="${incident.dateCreation != null}" class="text-muted">-</span>
                                            </td>
                                            <td class="text-end table-actions">
                                                <!-- Bouton selon le statut -->
                                                <form th:if="${incident.statut != null and incident.statut.name() == 'PRIS_EN_CHARGE'}"
                                                      th:action="@{/agent/incidents/{id}/en-resolution(id=${incident.id})}" 
                                                      method="post"
                                                      style="display: inline;"
                                                      onsubmit="return confirm('Voulez-vous mettre cet incident en résolution ?');">
                                                    <button type="submit" class="btn btn-sm btn-warning">
                                                        <i class="fas fa-tools"></i> En résolution
                                                    </button>
                                                </form>
                                                
                                                <form th:if="${incident.statut != null and incident.statut.name() == 'EN_RESOLUTION'}"
                                                      th:action="@{/agent/incidents/{id}/resolu(id=${incident.id})}" 
                                                      method="post"
                                                      style="display: inline;"
                                                      onsubmit="return confirm('Confirmez-vous que cet incident est résolu ?');">
                                                    <button type="submit" class="btn btn-sm btn-success">
                                                        <i class="fas fa-check"></i> Marquer résolu
                                                    </button>
                                                </form>
                                                
                                                <a th:href="@{/agent/incidents/{id}(id=${incident.id})}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> Voir
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const statutData = /*[[${incidentsParStatut}]]*/ {};
            const prioriteData = /*[[${incidentsParPriorite}]]*/ {};

            const statutColors = {
                'SIGNALE': '#6c757d',
                'PRIS_EN_CHARGE': '#17a2b8',
                'EN_RESOLUTION': '#ffc107',
                'RESOLU': '#28a745',
                'CLOTURE': '#dc3545'
            };

            const prioriteColors = {
                'BASSE': '#6c757d',
                'MOYENNE': '#007bff',
                'HAUTE': '#ffc107',
                'URGENTE': '#dc3545'
            };

            const statutCtx = document.getElementById('statutChart');
            if (statutCtx && statutData && Object.keys(statutData).length > 0) {
                const labels = Object.keys(statutData);
                const values = Object.values(statutData);
                const colors = labels.map(label => statutColors[label] || '#6c757d');

                new Chart(statutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15, font: { size: 12 } }
                            }
                        }
                    }
                });
            } else if (statutCtx) {
                const parent = statutCtx.parentElement;
                parent.innerHTML = '<div class="empty-state"><i class="fas fa-chart-pie"></i><p>Aucune donnée disponible</p></div>';
            }

            const prioriteCtx = document.getElementById('prioriteChart');
            if (prioriteCtx && prioriteData && Object.keys(prioriteData).length > 0) {
                const labels = Object.keys(prioriteData);
                const values = Object.values(prioriteData);
                const colors = labels.map(label => prioriteColors[label] || '#007bff');

                new Chart(prioriteCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nombre d\'incidents',
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 0,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, precision: 0 }
                            }
                        }
                    }
                });
            } else if (prioriteCtx) {
                const parent = prioriteCtx.parentElement;
                parent.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>Aucune donnée disponible</p></div>';
            }
        });
        /*]]>*/
    </script>
</body>
</html>